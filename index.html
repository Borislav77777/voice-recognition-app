<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f7fa;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle {
            background-color: #3498db;
            color: white;
        }

        .toggle:hover {
            background-color: #2980b9;
        }

        .toggle.active {
            background-color: #e74c3c;
        }

        .clear {
            background-color: #95a5a6;
            color: white;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏</h1>
        <textarea id="output" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
        <div class="buttons">
            <button class="toggle" onclick="toggleRecognition()">üé§ –°—Ç–∞—Ä—Ç</button>
            <button class="clear" onclick="clearText()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="status" id="status"></div>
    </div>

    <script>
        let recognition = null;
        let isRecognizing = false;

        // –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
        const DICTIONARY = {
            —Ç–æ—á–∫–∞: '.',
            –∑–∞–ø—è—Ç–∞—è: ',',
            –≤–æ–ø—Ä–æ—Å: '?',
            –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–µ: '!',
            –¥–≤–æ–µ—Ç–æ—á–∏–µ: ':',
            —Ç–∏—Ä–µ: '-',
            –∞–±–∑–∞—Ü: '\n'
        };

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
        function formatText(text) {
            return text
                .split(' ')
                .map(word => {
                    word = word.trim();
                    return DICTIONARY[word.toLowerCase()] || word;
                })
                .join(' ')
                .replace(/\s+([.,:!?-])/g, '$1')
                .replace(/\s+/g, ' ');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        function initRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome.');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'ru-RU';
            
            recognition.onstart = () => {
                console.log('Recognition started');
                updateStatus('–ì–æ–≤–æ—Ä–∏—Ç–µ...');
                const toggleBtn = document.querySelector('.toggle');
                toggleBtn.textContent = 'üõë –°—Ç–æ–ø';
                toggleBtn.classList.add('active');
                isRecognizing = true;
            };
            
            recognition.onend = () => {
                console.log('Recognition ended');
                if (isRecognizing) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Restart error:', e);
                        isRecognizing = false;
                        updateStatus('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞');
                    }
                } else {
                    updateStatus('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    const toggleBtn = document.querySelector('.toggle');
                    toggleBtn.textContent = 'üé§ –°—Ç–∞—Ä—Ç';
                    toggleBtn.classList.remove('active');
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    isRecognizing = false;
                    updateStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                    const toggleBtn = document.querySelector('.toggle');
                    toggleBtn.textContent = 'üé§ –°—Ç–∞—Ä—Ç';
                    toggleBtn.classList.remove('active');
                }
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    }
                }
                
                if (finalTranscript) {
                    const output = document.getElementById('output');
                    const formattedText = formatText(finalTranscript);
                    output.value = (output.value + formattedText).trim();
                    output.scrollTop = output.scrollHeight;
                }
            };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        async function checkMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('Microphone error:', error);
                updateStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                return false;
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        function toggleRecognition() {
            if (!recognition) {
                initRecognition();
            }
            
            if (!recognition) return;
            
            if (!isRecognizing) {
                checkMicrophone().then(hasAccess => {
                    if (hasAccess) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('Start error:', e);
                            updateStatus('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞');
                        }
                    }
                });
            } else {
                try {
                    isRecognizing = false;
                    recognition.stop();
                } catch (e) {
                    console.error('Stop error:', e);
                    updateStatus('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
                }
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
        function clearText() {
            document.getElementById('output').value = '';
            updateStatus('');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkMicrophone();
            if (hasAccess) {
                initRecognition();
            }
        });
    </script>
</body>
</html>
